# Scripts de Despliegue - Sistema de Carga de Veh√≠culos El√©ctricos

Scripts para automatizar la instalaci√≥n y configuraci√≥n del sistema distribuido con Kafka.

## üìÅ Archivos

- **`setup_kafka.sh`** - Instala y configura Kafka en cada m√°quina
- **`create_topics.sh`** - Crea los topics necesarios en Kafka
- **`deploy_app.sh`** - Despliega la aplicaci√≥n Python seg√∫n el rol

## üöÄ Proceso de Despliegue

### 1. Preparaci√≥n de M√°quinas

En cada una de las 3 m√°quinas, ejecutar:

```bash
# Actualizar sistema
sudo apt update && sudo apt upgrade -y

# Instalar Java (requerido para Kafka)
sudo apt install default-jdk -y

# Instalar Python
sudo apt install python3 python3-pip python3-venv -y

# Verificar Java
java -version
```

### 2. Instalaci√≥n de Kafka

En cada m√°quina ejecutar con el n√∫mero correspondiente:

```bash
# M√°quina 1
./setup_kafka.sh 1

# M√°quina 2  
./setup_kafka.sh 2

# M√°quina 3
./setup_kafka.sh 3
```

### 3. Iniciar Servicios de Kafka

En cada m√°quina:

```bash
# Iniciar servicios
sudo systemctl start zookeeper
sudo systemctl start kafka

# Habilitar arranque autom√°tico
sudo systemctl enable zookeeper
sudo systemctl enable kafka

# Verificar estado
sudo systemctl status zookeeper
sudo systemctl status kafka
```

### 4. Crear Topics

Ejecutar **solo una vez** desde cualquier m√°quina:

```bash
./create_topics.sh
```

### 5. Desplegar Aplicaciones

#### M√°quina 1 (Central):
```bash
./deploy_app.sh central
sudo systemctl start evcharging-central
sudo systemctl enable evcharging-central
```

#### M√°quina 2 (CPs):
```bash
./deploy_app.sh cp

# Iniciar CPs espec√≠ficos
sudo systemctl start evcharging-cp@CP001
sudo systemctl start evcharging-cp@CP002
sudo systemctl enable evcharging-cp@CP001
sudo systemctl enable evcharging-cp@CP002

# O usar el script de gesti√≥n
/opt/evcharging/manage_cps.sh start CP001
/opt/evcharging/manage_cps.sh start CP002
```

#### M√°quina 3 (Drivers):
```bash
./deploy_app.sh driver

# Iniciar driver interactivo
/opt/evcharging/start_driver.sh DRIVER001

# O solicitar autorizaci√≥n simple
/opt/evcharging/request_auth.sh DRIVER001 CP001
```

## üîß Scripts Detallados

### `setup_kafka.sh`

**Uso**: `./setup_kafka.sh <machine_number>`

**Funciones**:
- Descarga e instala Kafka
- Configura Zookeeper para cluster de 3 nodos
- Configura broker Kafka con ID √∫nico
- Crea servicios systemd
- Configura red y puertos

**Par√°metros**:
- `machine_number`: 1, 2 o 3

### `create_topics.sh`

**Funciones**:
- Crea todos los topics necesarios
- Configura particiones (3) y replicaci√≥n (2)
- Verifica que los topics se crearon correctamente

**Topics creados**:
- cp-register, cp-register-ack
- auth-request, auth-response  
- cp-commands, telemetry, health

### `deploy_app.sh`

**Uso**: `./deploy_app.sh <role>`

**Roles disponibles**:
- `central`: Despliega servidor central
- `cp`: Despliega servicios para CPs
- `driver`: Despliega scripts para drivers

**Funciones**:
- Crea entorno virtual Python
- Instala dependencias
- Configura servicios systemd
- Crea scripts de utilidad

## üéõÔ∏è Gesti√≥n de Servicios

### Comandos B√°sicos:

```bash
# Ver estado de todos los servicios
sudo systemctl status zookeeper kafka evcharging-*

# Ver logs
sudo journalctl -u evcharging-central -f
sudo journalctl -u evcharging-cp@CP001 -f

# Reiniciar servicios
sudo systemctl restart evcharging-central
sudo systemctl restart evcharging-cp@CP001
```

### Gesti√≥n de CPs:

```bash
# Ver todos los CPs
/opt/evcharging/manage_cps.sh list

# Ver estado de todos los CPs
/opt/evcharging/manage_cps.sh status

# Iniciar/parar CP espec√≠fico
/opt/evcharging/manage_cps.sh start CP001
/opt/evcharging/manage_cps.sh stop CP001
```

## üìä Monitoreo

### Verificar Kafka:

```bash
# Listar topics
/opt/kafka/bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# Ver mensajes en tiempo real
/opt/kafka/bin/kafka-console-consumer.sh --topic telemetry --bootstrap-server localhost:9092

# Ver consumer groups
/opt/kafka/bin/kafka-consumer-groups.sh --list --bootstrap-server localhost:9092
```

### Verificar Aplicaciones:

```bash
# Logs del central
tail -f /var/log/syslog | grep evcharging-central

# Logs de CPs
tail -f /var/log/syslog | grep evcharging-cp
```

## üö® Troubleshooting

### Problemas Comunes:

1. **Kafka no inicia**:
   ```bash
   # Verificar logs
   sudo journalctl -u kafka -f
   # Verificar Java
   java -version
   ```

2. **Topics no se crean**:
   ```bash
   # Verificar conectividad
   telnet localhost 9092
   # Verificar Zookeeper
   sudo systemctl status zookeeper
   ```

3. **Aplicaci√≥n no se conecta**:
   ```bash
   # Verificar configuraci√≥n
   cat /opt/evcharging/kafka_config.yaml
   # Verificar IPs de red
   ip addr show
   ```

### Reinicio Completo:

```bash
# Parar todo
sudo systemctl stop evcharging-* kafka zookeeper

# Limpiar datos (CUIDADO: borra todo)
sudo rm -rf /tmp/kafka-logs /tmp/zookeeper

# Reiniciar servicios
sudo systemctl start zookeeper kafka evcharging-*
```

## üìã Checklist de Despliegue

- [ ] Java instalado en todas las m√°quinas
- [ ] Python 3.7+ instalado en todas las m√°quinas  
- [ ] IPs configuradas en `kafka_config.yaml`
- [ ] Kafka instalado y configurado (3 m√°quinas)
- [ ] Servicios Zookeeper y Kafka iniciados (3 m√°quinas)
- [ ] Topics creados (una vez)
- [ ] Aplicaciones desplegadas seg√∫n rol
- [ ] Servicios de aplicaci√≥n iniciados
- [ ] Verificaci√≥n de conectividad completa

¬°Con estos scripts tendr√°s el sistema distribuido funcionando en minutos!